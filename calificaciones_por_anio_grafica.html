<!DOCTYPE html>
<html>
<head>
    <title>Calificaciones por Año</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
</head>
<body>
    <canvas id="myChart"></canvas>
    <input type="range" id="yearSlider" min="2004" max="2025" step="1" value="2025" style="width: 100%;">
    <!-- Cambiamos la fuente del texto del año -->
    <p style="text-align: center; font-family: 'Raleway', sans-serif; font-size: 12px;">
        Año seleccionado: <span id="selectedYear" style="font-weight: normal; font-size:12px;">2025</span>
    </p>
    <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        const yearSlider = document.getElementById('yearSlider');
        const selectedYearDisplay = document.getElementById('selectedYear');

        let jsonData = []; // Variable para almacenar los datos cargados

        // Función para filtrar y procesar datos por año
        function filterDataByYear(year) {
            const dataForYear = jsonData.filter(item => item["A\u00f1o"] === year);
            return {
                labels: dataForYear.map(item => item["Calificaci\u00f3n"]),
                values: dataForYear.map(item => item["Cantidad"])
            };
        }

        // Inicializar la gráfica sin datos
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: `Libros Leídos`,
                    data: [],
                    backgroundColor: 'rgba(92, 165, 147, 1)',
                    hoverBackgroundColor: 'rgba(45, 108, 104, 1)',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Calificaciones por Año',
                        font: {
                            size: 20,
                            weight: 'bold',
                            family: 'Raleway'
                        },
                        align: 'start'
                    },
                    subtitle: {
                        display: true,
                        text: 'Libros leídos agrupados por calificación',
                        font: {
                            size: 14,
                            family: 'Raleway',
                            weight: 'normal',
                        },
						padding: {
                            bottom: 25,
							top: 0
						},
                        align: 'start'
                    },
                    datalabels: {
                        display: true,
                        color: 'black',
                        anchor: 'end',
                        align: 'top',
                        font: {
                            family: 'Raleway',
                            size: 11,
                            weight: 'normal'
                        },
                        formatter: value => value
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Calificación',
                            font: {
                                family: 'Raleway',
                                size: 12,
                                weight: 'normal'
                            }
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Cantidad de Libros',
                            font: {
                                family: 'Raleway',
                                size: 12,
                                weight: 'normal'
                            }
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Cargar datos desde el archivo JSON
        fetch('calificaciones_por_anio_grafica.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                jsonData = data; // Asignar los datos cargados a la variable jsonData
                const initialYear = parseInt(yearSlider.value);
                const initialData = filterDataByYear(initialYear);

                // Actualizar la gráfica con los datos iniciales
                myChart.data.labels = initialData.labels;
                myChart.data.datasets[0].data = initialData.values;
                myChart.data.datasets[0].label = `Libros Leídos (${initialYear})`;
                myChart.update();
            })
            .catch(error => console.error('Error al cargar el archivo JSON:', error));

        // Actualizar gráfica cuando se mueve el slider
        yearSlider.addEventListener('input', () => {
            const selectedYear = parseInt(yearSlider.value);
            selectedYearDisplay.textContent = selectedYear;

            // Filtrar datos por el año seleccionado
            const updatedData = filterDataByYear(selectedYear);

            // Actualizar datos de la gráfica
            myChart.data.labels = updatedData.labels;
            myChart.data.datasets[0].data = updatedData.values;
            myChart.data.datasets[0].label = `Libros Leídos (${selectedYear})`;
            myChart.update();
        });
    </script>
</body>
</html>

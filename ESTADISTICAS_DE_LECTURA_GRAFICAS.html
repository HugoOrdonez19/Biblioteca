<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Gráficas Secundarias</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colores modo claro */
            --primary-bg: #FFFFFF; /* Fondo del cuerpo */
            --main-accent: #5ca593; /* Color de acento principal */
            --dark-accent: #2d6c68; /* Color de título y elementos importantes */
            --text-color: #333; /* Color de texto general para contraste suave */
            --hover-bg: #dce8e5; /* Color de hover de tabla/botones */
            --button-active-bg: #4a8c7b; /* Tono más oscuro de main-accent para botón activo */
            --button-text-color: white;
            --shadow-color: rgba(0, 0, 0, 0.25); /* Sombra suave para elementos flotantes */
            --card-bg: #FFFFFF; /* Fondo de las tarjetas de gráficas */
            --chart-title-color: var(--dark-accent);
            --chart-subtitle-color: var(--text-color);
            --chart-label-color: var(--text-color);
            --chart-grid-color: #eee;
            --chart-bar-color: rgba(92, 165, 147, 1);
            --chart-bar-hover-color: rgba(45, 108, 104, 1);
            --chart-line-color: rgba(255, 127, 127, 0.7);
            --chart-line-point-color: rgba(255, 127, 127, 0.7);
        }

        /* Colores modo oscuro */
        [data-theme="dark"] {
            --primary-bg: #191818; /* Fondo del cuerpo */
            --main-accent: #6aa89c; /* Un poco más claro para contraste en oscuro */
            --dark-accent: #9bb5b3; /* Títulos y elementos importantes */
            --text-color: #e0e0e0; /* Texto general */
            --hover-bg: #3a3939; /* Hover de tabla/botones */
            --button-active-bg: #5c9489; /* Tono más oscuro de main-accent */
            --button-text-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.5); /* Sombra más pronunciada en oscuro */
            --card-bg: #252424; /* Fondo de las tarjetas de gráficas */
            --chart-title-color: var(--dark-accent);
            --chart-subtitle-color: var(--text-color);
            --chart-label-color: var(--text-color);
            --chart-grid-color: #444; /* Líneas de la cuadrícula más oscuras */
            --chart-bar-color: rgba(106, 168, 156, 1);
            --chart-bar-hover-color: rgba(90, 115, 138, 1);
            --chart-line-color: rgba(255, 127, 127, 0.7); /* Color de línea para modo oscuro */
            --chart-line-point-color: rgba(255, 127, 127, 0.7);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--primary-bg);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--dark-accent);
            margin-bottom: 30px;
            text-align: center;
            width: 100%;
            transition: color 0.3s ease;
        }

        .navigation-container {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 900px;
        }

        .nav-button {
            background-color: var(--main-accent);
            color: var(--button-text-color);
            padding: 9px 16px;
            border: none;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
            white-space: nowrap;
        }

        .nav-button:hover:not(:disabled) {
            background-color: var(--button-active-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .nav-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }

        .chart-dropdown {
            padding: 9px 25px 9px 15px;
            border: 1px solid var(--main-accent);
            border-radius: 8px;
            background-color: var(--primary-bg);
            font-family: 'Roboto', sans-serif;
            font-size: 12px;
            color: var(--text-color);
            box-shadow: 0 2px 4px var(--shadow-color);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235ca593'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            cursor: pointer;
            outline: none;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        [data-theme="dark"] .chart-dropdown {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236aa89c'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
             border-color: var(--main-accent);
        }
        
        #chartDisplayArea {
            width: 100%;
            max-width: 800px;
            min-height: 400px;
            height: auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 25px;
            opacity: 1;
            transform: translateY(0);
            transition: none;
            box-sizing: border-box;
            position: relative;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 6px 18px var(--shadow-color);
            padding: 20px;
            overflow: hidden;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .card-style {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 6px 18px var(--shadow-color);
            padding: 20px;
        }

        .chart-transition-out {
            opacity: 0;
            transform: translateY(20px);
        }

        .chartjs-canvas {
            max-width: 800px;
            width: 100%;
            height: 400px;
            box-sizing: border-box;
        }
        
        .donut-chart-canvas {
            max-width: 600px;
            height: 400px;
            box-sizing: border-box;
        }
        
        /* Estilos para el interruptor de modo nocturno */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            color: var(--text-color);
            font-size: 14px;
            gap: 10px;
            transition: color 0.3s ease;
        }

        .theme-switch {
            display: inline-block;
            height: 18px;
            position: relative;
            width: 36px;
        }

        .theme-switch input {
            display: none;
        }

        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            background-color: #fff;
            bottom: 3px;
            content: "";
            height: 12px;
            left: 3px;
            position: absolute;
            transition: .4s;
            width: 12px;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--main-accent);
        }

        input:checked + .slider:before {
            transform: translateX(18px);
        }

        @media (max-width: 768px) {
            .navigation-container {
                flex-direction: column;
                gap: 15px;
            }
            .nav-button, .chart-dropdown {
                width: 90%;
                text-align: center;
            }
            .chart-dropdown {
                background-position: right 15px center;
            }
            #chartDisplayArea {
                gap: 15px;
                min-height: 300px;
                height: auto;
                padding: 15px;
            }
            .chartjs-canvas, .donut-chart-canvas {
                padding: 0;
                height: 300px;
            }
            h1 {
                font-size: 24px;
            }
            .theme-switch-wrapper {
                top: 10px;
                left: 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round"></div>
        </label>
    </div>

    <div class="navigation-container">
        <button id="prevChartButton" class="nav-button">Anterior</button>
        <select id="chartSelector" class="chart-dropdown">
        </select>
        <button id="nextChartButton" class="nav-button">Siguiente</button>
    </div>

    <div id="chartDisplayArea" class="card-style">
    </div>

    <script>
        const chartData = {};
        const chartInstances = {};

        const chartDisplayArea = document.getElementById('chartDisplayArea');
        const chartSelector = document.getElementById('chartSelector');
        const prevChartButton = document.getElementById('prevChartButton');
        const nextChartButton = document.getElementById('nextChartButton');
        const themeToggle = document.getElementById('checkbox');

        async function renderLibrosLeidosAnioChart() {
            try {
                const jsonFileName = 'libros_leidos_grafica.json';
                if (!chartData[jsonFileName]) {
                    const response = await fetch(jsonFileName);
                    if (!response.ok) throw new Error(`Error al cargar ${jsonFileName}: ${response.statusText}`);
                    chartData[jsonFileName] = await response.json();
                }

                chartDisplayArea.innerHTML = '';
                if (chartInstances.currentChart) {
                    chartInstances.currentChart.destroy();
                    chartInstances.currentChart = null;
                }

                const canvas = document.createElement('canvas');
                canvas.id = 'librosLeidosChart';
                canvas.classList.add('chartjs-canvas');
                chartDisplayArea.appendChild(canvas);

                const data = chartData[jsonFileName];
                const labels = data.map(item => item['Año de Lectura']);
                const totalLibros = data.map(item => item['Total Libros Leídos']);
                const acumulados = data.map(item => item['Libros Leídos Acumulados']);
                const style = getComputedStyle(document.documentElement);

                const ctx = canvas.getContext('2d');
                chartInstances.currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total Libros Leídos',
                                data: totalLibros,
                                backgroundColor: style.getPropertyValue('--chart-bar-color'),
                                hoverBackgroundColor: style.getPropertyValue('--chart-bar-hover-color'),
                                yAxisID: 'y',
                                borderRadius: 8,
                            },
                            {
                                label: 'Libros Leídos Acumulados',
                                data: acumulados,
                                type: 'line',
                                borderColor: style.getPropertyValue('--chart-line-color'),
                                borderWidth: 2,
                                fill: false,
                                pointBackgroundColor: style.getPropertyValue('--chart-line-point-color'),
                                pointHoverRadius: 7,
                                tension: 0.5,
                                yAxisID: 'y1',
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
									boxWidth:7.75,	
									boxHeight:7.75,
									usePointStyle: true,
                                    font: { 
										size: 12, 
										family: 'Roboto' 
									},
                                    color: style.getPropertyValue('--chart-label-color')
                                },
                            },
                            title: {
                                display: true,
                                text: 'Libros Leídos por Año',
                                font: { 
									size: 20, 
									weight: 'bold', 
									family: 'Roboto' 
								},
                                align: 'start',
                                color: style.getPropertyValue('--chart-title-color'),
								padding: {
                                    bottom: 0,
                                    top: 0
                                },
                            },
                            subtitle: {
                                display: true,
                                text: 'Cantidad de libros leídos cada año y total acumulado',
                                font: { 
									size: 13, 
									family: 'Roboto', 
									weight: 'normal' 
								},
                                padding: { 
									bottom: 10, 
									top: 0 
								},
                                align: 'start',
                                color: style.getPropertyValue('--chart-subtitle-color')
                            },
                            datalabels: { 
								display: false 
							},
							tooltip: {
								displayColors: false,
								bodyFont: {
									size: 12,
									family: 'Roboto'
								},
								callbacks: {
									label: function (context) {
										const dataset = context.dataset;
										const value = context.parsed.y || context.raw;
										let labelText = '';
										
										// Construir el texto del label con el nombre del dataset y el valor
										if (dataset.label) {
											labelText = `${dataset.label}: `;
										}
										
										// Agregar el valor formateado
										if (value !== undefined && value !== null) {
											labelText += value.toLocaleString('es-GT', { 
												minimumFractionDigits: 0, 
												maximumFractionDigits: 2 
											});
										}
										
										return labelText;
									}
								},
								titleColor: function (context) {
									const dataPoint = context.tooltip.dataPoints[0];
									const dataset = dataPoint.dataset;
									
									// Verificar si es el dataset de línea (tiene type: 'line')
									if (dataset.type === 'line') {
										return getComputedStyle(document.documentElement).getPropertyValue('--chart-line-color').trim() || dataset.borderColor;
									} else {
										// Si no tiene type definido, es el dataset de barras (tipo base del chart)
										return getComputedStyle(document.documentElement).getPropertyValue('--chart-bar-color').trim() || dataset.backgroundColor;
									}
								},
								titleFont: {
									weight: 'bold',
									size: 13,
								}
							}
                        },
                        scales: {
                            y: {
								display: false,
                                type: 'linear', 
								position: 'left',
                                title: { 
									display: true, 
									text: 'Libros Leídos (Anual)', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                ticks: { 
									font: { size: 11, 
									family: 'Roboto' 
								}, 
								color: style.getPropertyValue('--chart-label-color'), 
								callback: value => Number.isInteger(value) ? value : '' 
								},
                                grid: { drawOnChartArea: false }, min: 0, max: 90,
                            },
                            y1: {
								display: false,
                                type: 'linear', 
								position: 'right',
                                title: { 
									display: true, 
									text: 'Libros Leídos (Acumulado)', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                grid: { 
									drawOnChartArea: false 
								},
                                ticks: { 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color'), 
									callback: value => Number.isInteger(value) ? value : '' 
								},
                                min: -50, max: 300,
                            },
                            x: {
                                grid: { 
									display: false 
								},
                                ticks: { 
									autoSkip: true, 
									maxRotation: 45, 
									minRotation: 0, 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                title: { 
									display: true, 
									text: 'Año de Lectura', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                            },
                        },
                        animation: { duration: 1000, easing: 'easeOutQuart' }
                    },
                    plugins: [ChartDataLabels],
                });
            } catch (error) {
                console.error('Error al renderizar la gráfica "Libros Leídos por Año":', error);
                chartDisplayArea.innerHTML = `<p style="color:red; text-align:center;">No se pudo cargar o renderizar la gráfica de libros por año.</p>`;
            }
        }

        async function renderAutoresLeidosAnioChart() {
            try {
                const jsonFileName = 'autores_leidos_grafica.json';
                if (!chartData[jsonFileName]) {
                    const response = await fetch(jsonFileName);
                    if (!response.ok) throw new Error(`Error al cargar ${jsonFileName}: ${response.statusText}`);
                    chartData[jsonFileName] = await response.json();
                }

                chartDisplayArea.innerHTML = '';
                if (chartInstances.currentChart) {
                    chartInstances.currentChart.destroy();
                    chartInstances.currentChart = null;
                }

                const canvas = document.createElement('canvas');
                canvas.id = 'autoresChart';
                canvas.classList.add('chartjs-canvas');
                chartDisplayArea.appendChild(canvas);

                const data = chartData[jsonFileName];
                const labels = data.map(item => item['Año de Lectura']);
                const totalAutores = data.map(item => item['Autores Únicos Anuales']);
                const acumulados = data.map(item => item['Total Acumulado de Autores Únicos']);
                const style = getComputedStyle(document.documentElement);

                const ctx = canvas.getContext('2d');
                chartInstances.currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Autores Leídos',
                                data: totalAutores,
                                backgroundColor: style.getPropertyValue('--chart-bar-color'),
                                hoverBackgroundColor: style.getPropertyValue('--chart-bar-hover-color'),
                                yAxisID: 'y',
                                borderRadius: 8,
                            },
                            {
                                label: 'Total de Autores Leídos',
                                data: acumulados,
                                type: 'line',
                                borderColor: style.getPropertyValue('--chart-line-color'),
                                borderWidth: 2,
                                fill: false,
                                pointBackgroundColor: style.getPropertyValue('--chart-line-point-color'),
                                pointHoverRadius: 6,
                                tension: 0.5,
                                yAxisID: 'y1',
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { 
									boxWidth:7.75,	
									boxHeight:7.75,
									usePointStyle: true,
									font: { 
										size: 12, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                            },
                            title: {
                                display: true, 
								text: 'Autores Leídos por Año',
								padding: {
                                    bottom: 0,
                                    top: 0
                                },
                                font: { 
									size: 20, 
									weight: 'bold', 
									family: 'Roboto' 
								}, 
								align: 'start', 
								color: style.getPropertyValue('--chart-title-color')
                            },
                            subtitle: {
                                display: true, 
								text: 'Cantidad de autores leídos cada año y total acumulado',
                                font: { 
									size: 13, 
									family: 'Roboto', 
									weight: 'normal' 
								}, 
								padding: { 
									bottom: 10, 
									top: 0 
								}, 
								align: 'start', 
								color: style.getPropertyValue('--chart-subtitle-color')
                            },
                            datalabels: { display: false },
							tooltip: {
								displayColors: false,
								bodyFont: {
									size: 12,
									family: 'Roboto'
								},
								callbacks: {
									label: function (context) {
										const dataset = context.dataset;
										const value = context.parsed.y || context.raw;
										let labelText = '';
										
										// Construir el texto del label con el nombre del dataset y el valor
										if (dataset.label) {
											labelText = `${dataset.label}: `;
										}
										
										// Agregar el valor formateado
										if (value !== undefined && value !== null) {
											labelText += value.toLocaleString('es-GT', { 
												minimumFractionDigits: 0, 
												maximumFractionDigits: 2 
											});
										}
										
										return labelText;
									}
								},
								titleColor: function (context) {
									const dataPoint = context.tooltip.dataPoints[0];
									const dataset = dataPoint.dataset;
									
									// Verificar si es el dataset de línea (tiene type: 'line')
									if (dataset.type === 'line') {
										return getComputedStyle(document.documentElement).getPropertyValue('--chart-line-color').trim() || dataset.borderColor;
									} else {
										// Si no tiene type definido, es el dataset de barras (tipo base del chart)
										return getComputedStyle(document.documentElement).getPropertyValue('--chart-bar-color').trim() || dataset.backgroundColor;
									}
								},
								titleFont: {
									weight: 'bold',
									size: 13,
								}
							}
                        },
                        scales: {
                            y: {
								display: false,
                                type: 'linear', 
								position: 'left',
                                title: { 
									display: true, 
									text: 'Autores Leídos (Anual)', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                ticks: { 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color'), 
									callback: value => Number.isInteger(value) ? value : '' 
								},
                                grid: { 
									drawOnChartArea: false 
								}, 
								min: 0, 
								max: 80,
                            },
                            y1: {
								display: false,
                                type: 'linear', position: 'right',
                                title: { 
									display: true, 
									text: 'Autores Leídos (Acumulado)', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                grid: { 
									drawOnChartArea: false 
								},
                                ticks: { 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color'), 
									callback: value => Number.isInteger(value) ? value : '' 
								},
                                min: -50, 
								max: 250,
                            },
                            x: {
                                grid: { 
									display: false 
								},
                                ticks: { 
									autoSkip: true, 
									maxRotation: 45, 
									minRotation: 0, 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                title: { 
									display: true, 
									text: 'Año de Lectura', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                            },
                        },
                        animation: { duration: 1000, easing: 'easeOutQuart' }
                    },
                    plugins: [ChartDataLabels],
                });
            } catch (error) {
                console.error('Error al renderizar la gráfica "Autores Leídos por Año":', error);
                chartDisplayArea.innerHTML = `<p style="color:red; text-align:center;">No se pudo cargar o renderizar la gráfica de autores por año.</p>`;
            }
        }

        async function renderPaginasLeidasAnioChart() {
            try {
                const jsonFileName = 'paginas_leidas_grafica.json';
                if (!chartData[jsonFileName]) {
                    const response = await fetch(jsonFileName);
                    if (!response.ok) throw new Error(`Error al cargar ${jsonFileName}: ${response.statusText}`);
                    chartData[jsonFileName] = await response.json();
                }

                chartDisplayArea.innerHTML = '';
                if (chartInstances.currentChart) {
                    chartInstances.currentChart.destroy();
                    chartInstances.currentChart = null;
                }

                const canvas = document.createElement('canvas');
                canvas.id = 'paginasLeidasChart';
                canvas.classList.add('chartjs-canvas');
                chartDisplayArea.appendChild(canvas);

                const data = chartData[jsonFileName];
                const labels = data.map(item => item['Año de Lectura']);
                const totalPaginas = data.map(item => item['Páginas Leídas Anuales']);
                const acumulados = data.map(item => item['Total Acumulado de Páginas']);
                const style = getComputedStyle(document.documentElement);

                const ctx = canvas.getContext('2d');
                chartInstances.currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Páginas Leídas',
                                data: totalPaginas,
                                backgroundColor: style.getPropertyValue('--chart-bar-color'),
                                hoverBackgroundColor: style.getPropertyValue('--chart-bar-hover-color'),
                                yAxisID: 'y',
                                borderRadius: 8,
                            },
                            {
                                label: 'Total de Páginas Leídas',
                                data: acumulados,
                                type: 'line',
                                borderColor: style.getPropertyValue('--chart-line-color'),
                                borderWidth: 2,
                                fill: false,
                                pointBackgroundColor: style.getPropertyValue('--chart-line-point-color'),
                                pointHoverRadius: 6,
                                tension: 0.5,
                                yAxisID: 'y1',
                            },
                        ],
                    },
                    options: {
                        responsive: true, 
						maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
									boxWidth:7.75,	
									boxHeight:7.75,
									usePointStyle: true,
									font: { 
										size: 12, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                            },
                            title: {
                                display: true, 
								text: 'Páginas Leídas por Año',
								padding: {
                                    bottom: 0,
                                    top: 0
                                },
                                font: { 
									size: 20, 
									weight: 'bold', 
									family: 'Roboto' 
								}, 
								align: 'start', 
								color: style.getPropertyValue('--chart-title-color')
                            },
                            subtitle: {
                                display: true, 
								text: 'Cantidad de páginas leídas cada año y total acumulado',
                                font: { 
									size: 13, 
									family: 'Roboto', 
									weight: 'normal' 
								}, 
								padding: { 
									bottom: 10, 
									top: 0 
								}, 
								align: 'start', 
								color: style.getPropertyValue('--chart-subtitle-color')
                            },
                            datalabels: { 
								display: false 
							},
							tooltip: {
								displayColors: false,
								bodyFont: {
									size: 12,
									family: 'Roboto'
								},
								callbacks: {
									label: function (context) {
										const dataset = context.dataset;
										const value = context.parsed.y || context.raw;
										let labelText = '';
										
										// Construir el texto del label con el nombre del dataset y el valor
										if (dataset.label) {
											labelText = `${dataset.label}: `;
										}
										
										// Agregar el valor formateado
										if (value !== undefined && value !== null) {
											labelText += value.toLocaleString('es-GT', { 
												minimumFractionDigits: 0, 
												maximumFractionDigits: 2 
											});
										}
										
										return labelText;
									}
								},
								titleColor: function (context) {
									const dataPoint = context.tooltip.dataPoints[0];
									const dataset = dataPoint.dataset;
									
									// Verificar si es el dataset de línea (tiene type: 'line')
									if (dataset.type === 'line') {
										return getComputedStyle(document.documentElement).getPropertyValue('--chart-line-color').trim() || dataset.borderColor;
									} else {
										// Si no tiene type definido, es el dataset de barras (tipo base del chart)
										return getComputedStyle(document.documentElement).getPropertyValue('--chart-bar-color').trim() || dataset.backgroundColor;
									}
								},
								titleFont: {
									weight: 'bold',
									size: 13,
								}
							}
                        },
                        scales: {
                            y: {
								display: false,
                                type: 'linear', 
								position: 'left',
                                title: { 
									display: true, 
									text: 'Páginas Leídas (Anual)', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color')
								},
                                ticks: { 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color'), 
									callback: value => Number.isInteger(value) ? value : '' 
								},
                                grid: { 
									drawOnChartArea: false 
								}, 
								min: 0, 
								max: 25000,
                            },
                            y1: {
								display: false,
                                type: 'linear', 
								position: 'right',
                                title: { 
									display: true, 
									text: 'Páginas Leídas (Acumulado)', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                grid: { 
									drawOnChartArea: false 
								},
                                ticks: { 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color'), 
									callback: value => Number.isInteger(value) ? value : '' 
								},
                                min: -10000, 
								max: 80000,
                            },
                            x: {
                                grid: { 
									display: false 
								},
                                ticks: { 
									autoSkip: true, 
									maxRotation: 45, 
									minRotation: 0, 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                title: { 
									display: true, 
									text: 'Año de Lectura', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                            },
                        },
                        animation: { duration: 1000, easing: 'easeOutQuart' }
                    },
                    plugins: [ChartDataLabels],
                });
            } catch (error) {
                console.error('Error al renderizar la gráfica "Páginas Leídas por Año":', error);
                chartDisplayArea.innerHTML = `<p style="color:red; text-align:center;">No se pudo cargar o renderizar la gráfica de páginas por año.</p>`;
            }
        }

        async function renderFormatoGraficaChart() {
            try {
                const jsonFileName = 'formato_grafica.json';
                if (!chartData[jsonFileName]) {
                    const response = await fetch(jsonFileName);
                    if (!response.ok) throw new Error(`Error al cargar ${jsonFileName}: ${response.statusText}`);
                    chartData[jsonFileName] = await response.json();
                }

                chartDisplayArea.innerHTML = '';
                if (chartInstances.currentChart) {
                    chartInstances.currentChart.destroy();
                    chartInstances.currentChart = null;
                }

                const canvas = document.createElement('canvas');
                canvas.id = 'formatoChart';
                canvas.classList.add('donut-chart-canvas');
                chartDisplayArea.appendChild(canvas);

                const data = chartData[jsonFileName];
                const labels = data.map(item => item.Formato);
                const values = data.map(item => item["Total Libros"]);
                const style = getComputedStyle(document.documentElement);

                const colors = [
                    'rgba(92, 165, 147, 1)', 'rgba(135, 194, 163, 1)',
                    'rgba(173, 213, 187, 1)', 'rgba(45, 108, 104, 1)'
                ];

                const ctx = canvas.getContext('2d');
                chartInstances.currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [
							{
								data: values, 
								backgroundColor: colors,
								hoverBackgroundColor: colors.map(color => color.replace('1)', '0.8)')),
								borderWidth: 0, 
								hoverOffset: 20,
							}
						]
                    },
                    options: {
                        responsive: true, 
						maintainAspectRatio: false,
                        layout: { 
							padding: { 
								bottom: 30 
							} 
						},
                        plugins: {
                            title: {
                                display: true, 
								text: 'Formato', 
								font: { 
									size: 20, 
									family: 'Roboto' 
								},
                                align: 'start', 
								color: style.getPropertyValue('--chart-title-color'),
								padding: {
                                    bottom: 0,
                                    top: 0
                                },
                            },
                            subtitle: {
                                display: true, 
								text: 'Libros leídos agrupados por formato de lectura',
                                font: { 
									size: 13, 
									family: 'Roboto' 
								}, 
								align: 'start',
                                padding: { 
									bottom: 20 
								}, 
								color: style.getPropertyValue('--chart-subtitle-color')
                            },
                            datalabels: { 
								display: false 
							},
                            legend: {
                                display: true, 
								position: 'top',
                                labels: {
									boxWidth:7.75,	
									boxHeight:7.75,
									usePointStyle: true,
									font: { 
										family: 'Roboto', 
										size: 12 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								}
                            },
							tooltip: {
								displayColors: false,
								bodyFont: {
									size: 12,
									family: 'Roboto'
								},
								callbacks: {
									title: function(tooltipItems) {
										const item = tooltipItems[0];
										if (item) {
											const dataset = item.chart.data.datasets[item.datasetIndex];
											return dataset.label;
										}
										return '';
									},
									label: function(context) {
										let labelText = '';

										if (context.raw !== undefined && context.raw !== null) {
											labelText += `${context.raw.toLocaleString('es-GT', { minimumFractionDigits: 0, maximumFractionDigits: 2 })} libros`;
										}

										return labelText;
									}
								},
								titleColor: function(context) {
									const tooltip = context.tooltip;
									if (tooltip.dataPoints.length > 0) {
										const dataPoint = tooltip.dataPoints[0];
										const dataset = dataPoint.dataset;
										if (dataset.backgroundColor) {
											return dataset.backgroundColor[dataPoint.dataIndex] || dataset.backgroundColor;
										}
									}
									return 'rgba(0, 0, 0, 0.8)';
								},
								titleFont: {
									weight: 'bold',
									size:13,
								}
							}
                        },
                        animation: { 
							animateScale: true, 
							animateRotate: true 
						},
                    },
                    plugins: [ChartDataLabels],
                });
            } catch (error) {
                console.error('Error al renderizar la gráfica "Formato":', error);
                chartDisplayArea.innerHTML = '<p style="color:red; text-align:center;">No se pudo cargar o renderizar la gráfica de formato.</p>';
            }
        }

        async function renderTipoLecturaGraficaChart() {
            try {
                const jsonFileName = 'tipo_de_lectura_grafica.json';
                if (!chartData[jsonFileName]) {
                    const response = await fetch(jsonFileName);
                    if (!response.ok) throw new Error(`Error al cargar ${jsonFileName}: ${response.statusText}`);
                    chartData[jsonFileName] = await response.json();
                }

                chartDisplayArea.innerHTML = '';
                if (chartInstances.currentChart) {
                    chartInstances.currentChart.destroy();
                    chartInstances.currentChart = null;
                }

                const canvas = document.createElement('canvas');
                canvas.id = 'tipoLecturaChart';
                canvas.classList.add('donut-chart-canvas');
                chartDisplayArea.appendChild(canvas);

                const data = chartData[jsonFileName];
                const labels = data.map(item => item["Tipo de Lectura"]);
                const values = data.map(item => item["Total Libros"]);
                const style = getComputedStyle(document.documentElement);

                const colors = [
                    'rgba(92, 165, 147, 1)', 'rgba(135, 194, 163, 1)',
                    'rgba(173, 213, 187, 1)', 'rgba(45, 108, 104, 1)',
					'rgba(30, 80, 75, 1)',
                ];

                const ctx = canvas.getContext('2d');
                chartInstances.currentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [
							{
								data: values, 
								backgroundColor: colors,
								hoverBackgroundColor: colors.map(color => color.replace('1)', '0.8)')),
								borderWidth: 0, 
								hoverOffset: 20,
							}
						]
                    },
                    options: {
                        responsive: true, 
						maintainAspectRatio: false,
                        layout: { 
							padding: { 
								bottom: 30 
							} 
						},
                        plugins: {
                            title: {
                                display: true, 
								text: 'Tipo de Lectura',
                                font: { 
									size: 20, 
									family: 'Roboto' 
								}, 
								align: 'start', 
								color: style.getPropertyValue('--chart-title-color'),
								padding: {
                                    bottom: 0,
                                    top: 0
                                },
                            },
                            subtitle: {
                                display: true, 
								text: 'Libros leídos agrupados por tipo de lectura',
                                font: { 
									size: 13, 
									family: 'Roboto' 
								}, 
								align: 'start',
                                padding: { 
									bottom: 20 
								}, 
								color: style.getPropertyValue('--chart-subtitle-color')
                            },
                            datalabels: { 
								display: false 
							},
                            legend: {
                                display: true, 
								position: 'top',
                                labels: { 
									boxWidth:7.75,	
									boxHeight:7.75,
									usePointStyle: true,
									font: { 
										family: 'Roboto', 
										size: 12 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								}
                            },
                            tooltip: {
								displayColors: false,
								bodyFont: {
									size: 12,
									family: 'Roboto'
								},
								callbacks: {
									title: function(tooltipItems) {
										const item = tooltipItems[0];
										if (item) {
											const dataset = item.chart.data.datasets[item.datasetIndex];
											return dataset.label;
										}
										return '';
									},
									label: function(context) {
										let labelText = '';

										if (context.raw !== undefined && context.raw !== null) {
											labelText += `${context.raw.toLocaleString('es-GT', { minimumFractionDigits: 0, maximumFractionDigits: 2 })} libros`;
										}

										return labelText;
									}
								},
								titleColor: function(context) {
									const tooltip = context.tooltip;
									if (tooltip.dataPoints.length > 0) {
										const dataPoint = tooltip.dataPoints[0];
										const dataset = dataPoint.dataset;
										if (dataset.backgroundColor) {
											return dataset.backgroundColor[dataPoint.dataIndex] || dataset.backgroundColor;
										}
									}
									return 'rgba(0, 0, 0, 0.8)';
								},
								titleFont: {
									weight: 'bold'
								}
							}
                        },
                        animation: { 
							animateScale: true, 
							animateRotate: true 
						},
                    },
                    plugins: [ChartDataLabels],
                });
            } catch (error) {
                console.error('Error al renderizar la gráfica "Tipo de Lectura":', error);
                chartDisplayArea.innerHTML = '<p style="color:red; text-align:center;">No se pudo cargar o renderizar la gráfica de tipo de lectura.</p>';
            }
        }
        
        async function renderScatterChart() {
            try {
                const jsonFileName = 'publicacion_vs_lectura.json';
                if (!chartData[jsonFileName]) {
                    const response = await fetch(jsonFileName);
                    if (!response.ok) throw new Error(`Error al cargar ${jsonFileName}: ${response.statusText}`);
                    chartData[jsonFileName] = await response.json();
                }

                chartDisplayArea.innerHTML = '';
                if (chartInstances.currentChart) {
                    chartInstances.currentChart.destroy();
                    chartInstances.currentChart = null;
                }

                const canvas = document.createElement('canvas');
                canvas.id = 'scatterChart';
                canvas.classList.add('chartjs-canvas');
                chartDisplayArea.appendChild(canvas);

                const data = chartData[jsonFileName];
                const dataset = data.map(item => ({
                    x: item["Año de Lectura"], 
					y: item["Año de publicación"],
                    r: item["Total Libros Leídos"]*7 ,
                }));
                const allReadYears = Array.from(new Set(data.map(item => item["Año de Lectura"]))).sort((a, b) => a - b);
                const minReadYear = Math.min(...allReadYears);
                const maxReadYear = Math.max(...allReadYears);
                const style = getComputedStyle(document.documentElement);

                const ctx = canvas.getContext('2d');
                chartInstances.currentChart = new Chart(ctx, {
                    type: 'bubble',
                    data: {
                        datasets: [
							{
								label: 'Año Leído vs. Año de Publicación', 
								data: dataset,
								backgroundColor: style.getPropertyValue('--chart-bar-color'),
                                hoverBackgroundColor: style.getPropertyValue('--chart-bar-hover-color'),
								borderWidth: 1, 
								hoverRadius: 10,
								hitRadius:5,
								radius:25,
							}
						]
                    },
                    options: {
                        responsive: true, 
						maintainAspectRatio: false,
                        plugins: {
                            legend: { 
								display: false 
							},
                            title: {
                                display: true, 
								text: 'Año Leído vs. Año de Publicación',
                                font: { 
									size: 20, 
									weight: 'bold', 
									family: 'Roboto' 
								}, 
								align: 'start', 
								color: style.getPropertyValue('--chart-title-color'),
								padding: {
                                    bottom: 0,
                                    top: 0
                                },
                            },
                            subtitle: {
                                display: true, 
								text: 'Relación entre el año de lectura y el año de publicación de los libros leídos (tamaño de la burbuja: total de libros leídos)',
                                font: { 
									size: 13, 
									family: 'Roboto' 
								}, 
								padding: { 
									bottom: 30, 
									top: 0 
								}, 
								align: 'start', 
								color: style.getPropertyValue('--chart-subtitle-color')
                            },
                            datalabels: { 
								display: false 
							},
							tooltip: {
								displayColors: false,
								bodyFont: {
									size: 12,
									family: 'Roboto'
								},
								callbacks: {
									title: function (tooltipItems) {
										const item = tooltipItems[0];
										return item ? `Año de Lectura: ${item.raw.x}` : '';
									},
									label: function (context) {
										const { x, y, r } = context.raw;
										return [
											`Año de Publicación: ${y}`,
											`Total Libros Leídos: ${(r / 7).toLocaleString('es-GT', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`
										];
									}
								},
								titleColor: function (context) {
									const style = getComputedStyle(document.documentElement);
									const dataPoint = context.tooltip.dataPoints[0];
									const dataset = dataPoint.dataset;

									// Cambia el color según la configuración de estilo
									return dataset.backgroundColor || style.getPropertyValue('--chart-bar-color').trim();
								},
								titleFont: {
									weight: 'bold',
									size: 13,
								},
								borderColor: function (context) {
									const style = getComputedStyle(document.documentElement);
									return style.getPropertyValue('--chart-bar-color').trim() || 'rgba(0, 0, 0, 0.1)';
								},
							}
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { 
									display: true, 
									text: 'Año de Lectura', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                ticks: { 
									autoSkip: false, 
									maxRotation: 90, 
									minRotation: 0, 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color'), 
									callback: value => Number.isInteger(value) ? value : null 
								},
                                min: minReadYear - 1, 
								max: maxReadYear + 1, 
								grid: { 
									display: false 
								},
                            },
                            y: {
                                title: { 
									display: true, 
									text: 'Año de Publicación', 
									font: { 
										family: 'Roboto', 
										size: 13 
									}, 
									color: style.getPropertyValue('--chart-label-color') 
								},
                                type: 'linear',
                                ticks: { 
									font: { 
										size: 11, 
										family: 'Roboto' 
									}, 
									color: style.getPropertyValue('--chart-label-color'), 
									callback: value => Number.isInteger(value) ? value : null 
								},
                                grid: { 
									drawOnChartArea: false 
								},
                            },
                        },
                        animation: { 
							duration: 1000, 
							easing: 'easeOutQuart' 
						},
                    },
                    plugins: [ChartDataLabels],
                });
            } catch (error) {
                console.error('Error al renderizar la gráfica "Año leído vs. Año de publicación":', error);
                chartDisplayArea.innerHTML = `<p style="color:red; text-align:center;">No se pudo cargar o renderizar la gráfica de dispersión.</p>`;
            }
        }

        const chartMap = {
            'libros-leidos-anio': { render: renderLibrosLeidosAnioChart, label: 'Libros Leídos por Año' },
            'autores-leidos-anio': { render: renderAutoresLeidosAnioChart, label: 'Autores Leídos por Año' },
            'paginas-leidas-anio': { render: renderPaginasLeidasAnioChart, label: 'Páginas Leídas por Año' },
            'formato-grafica': { render: renderFormatoGraficaChart, label: 'Libros por Formato' },
            'tipo-lectura-grafica': { render: renderTipoLecturaGraficaChart, label: 'Libros por Tipo de Lectura' },
            'publicacion-vs-lectura': { render: renderScatterChart, label: 'Año de Lectura vs. Publicación' }
        };

        const chartKeys = Object.keys(chartMap);
        let currentChartIndex = 0;

        function updateNavigationState() {
            chartSelector.value = chartKeys[currentChartIndex];
            prevChartButton.disabled = currentChartIndex === 0;
            nextChartButton.disabled = currentChartIndex === chartKeys.length - 1;
        }

        async function switchChart(newChartKeyOrIndex, forceRender = false) {
            let newIndex;
            if (typeof newChartKeyOrIndex === 'string') {
                newIndex = chartKeys.indexOf(newChartKeyOrIndex);
            } else {
                newIndex = newChartKeyOrIndex;
            }

            if (newIndex === -1 || (newIndex === currentChartIndex && !forceRender)) return;

            if (newIndex !== currentChartIndex) {
                 currentChartIndex = newIndex;
            }
            
            updateNavigationState();

            if (chartInstances.currentChart) {
                chartInstances.currentChart.destroy();
                chartInstances.currentChart = null;
            }
            await chartMap[chartKeys[currentChartIndex]].render();
        }

        // --- Dark Mode Logic ---
        function setPreferredTheme() {
            const storedTheme = localStorage.getItem('theme');
            let themeToApply = 'light'; // Default
            if (storedTheme) {
                themeToApply = storedTheme;
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeToApply = 'dark';
            }
            document.documentElement.setAttribute('data-theme', themeToApply);
            themeToggle.checked = (themeToApply === 'dark');
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            switchChart(currentChartIndex, true); // Force re-render
        }

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', async () => {
            setPreferredTheme();
            themeToggle.addEventListener('change', toggleTheme);

            chartKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = chartMap[key].label;
                chartSelector.appendChild(option);
            });

            chartSelector.addEventListener('change', (event) => switchChart(event.target.value));
            prevChartButton.addEventListener('click', () => {
                if (currentChartIndex > 0) switchChart(currentChartIndex - 1);
            });
            nextChartButton.addEventListener('click', () => {
                if (currentChartIndex < chartKeys.length - 1) switchChart(currentChartIndex + 1);
            });

            await chartMap[chartKeys[currentChartIndex]].render();
            updateNavigationState();
        });
    </script>
</body>
</html>
